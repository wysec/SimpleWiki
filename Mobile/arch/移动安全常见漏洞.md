# 5.2 移动安全问题的分类

移动应用也像Web系统一样存在各种各样的问题，在我们对移动应用进行安全测试时，有必要对安全问题进行分类，这样可以指导我们进行安全测试。在进行测试前可以帮助我们了解到对移动应用要测试那些方面的问题；在测试过程中可以帮助我们确定还有那些问题要进行测试；在测试完后可以用来检查我们是否测试全面。

这里我们参考了OWASP 组织发布的移动应用安全问题分类，它将移动安全问题分成10大类，涵盖了移动应用最主要的10大安全问题。下面我们将对这10大类安全问题进行初步的介绍和说明，方便大家对这些问题有一个直观的了解。

## 5.2.1 平台使用不当

**概述**

移动平台提供了许多功能可以供开发人员使用。 但是，由于不正确的使用这些功能常常可能会导致开发的移动应用程序遭受攻击。此类别包括了平台功能的滥用，或未能使用平台的安全控制。比如滥用Touch ID、Keychain、Android intents、平台权限或移动操作系统的其它安全功能。

对于平台使用不当的问题，主要是指这样一些问题。

1. 违反已发布的开发准则。所有平台都指定有开发安全指南， 如果应用与这些平台推荐的最佳做法相违背，那么就将面临这种安全风险。
2. 违反最佳实践。除了按照平台提供的指导原则进行开发外，对于一些开发过程中的最佳实践也应该遵守，违反这样的最佳实践往往也会导致安全问题。
3. 无意的误用。有些时候本来应用是要执行正确的操作，但是由于在开发过程中的错误操作，比如错误设置了某个属性值，或是对保护机制的错误理解，最终导致了此安全问题。


**举例**

由于存在多个平台，且每个平台又有很多的功能特性。因此我们通过列举一些示例来说明此类安全问题。

1. 未限制对应用组件的访问

比如在Android中有四大组件（Activity、Service、Content Provider、Broadcast Receiver），对于这几个组件都有`android:exported`的属性，如果设置为`true`，那么此组件就可以被其它应用访问。当然如果是合理的业务需求这没什么问题，但是如果某个本不应被其它应用访问的组件被其`exported`属性被置为了`true`，比如一个需要认证后才能访问的查询数据的activity，在AndroidManifest.xml文件中设置为 `android:exported="false"`，那么攻击者或者恶意应用就可以直接绕过认证来调用此activity进行数据查询操作了。这就是一个比较典型的平台使用不当的安全问题。

2. 本地存储代替Keychain

对于iOS平台，其中的Keychain是一个对应用的保密数据安全存储的设备。在 iOS 中，应用应该使用它来存储安全的秘密数据（如：密钥、密码、证书等）。但是有些应用却将这些数据存放在应用的本地存储中。存放本地存储中的数据将会面临在“不安全的数据存储”中提到的安全风险。这也是较常见的在iOS平台的使用不当的安全问题。


## 5.2.2 不安全的数据存储

**概述**

不管什么移动应用，基本都会涉及到数据的存储。但是在开发时往往开发人员不能意识到攻击者或恶意软件能够访问设备上存储的数据文件。如果涉及到对敏感数据进行存储时，而又没有采取相应的安全控制措施，那么这将会是很严重的安全问题。

对于不同的平台会有不同的数据存储方式，比如在Android中，就有下面一些数据存储的机制：

- 文件存储，它不对存储的内容进行任何的格式化处理，所有数据都是原封不动地保存到文件当中。
- SharedPreferences，是通过使用XML结构将键值对的数据存储到文件系统中的常用方法。
- SQLite数据库，是一种轻量级的关系型数据库，它的运算速度非常快，占用资源很少，因此Android 也内置支持了SQLite数据库。
- 内部存储，移动应用的文件能被直接保存在设备的内部存储上，默认情况下，保存到内部存储中的文件是私有的，其他应用无法访问。 当用户卸载应用程序时，这些文件都将被删除。另外，应用的缓存也是保存在内部存储中。
- 外部存储，每个Android兼容设备都支持共享外部存储，可以使用它来保存文件。保存到外部存储中的文件是全局可读的，当用户通过USB连接到计算机上时，用户可以对其进行修改。特别注意的，保存在外部存储中的数据，当应用被卸载时不会被删除。


**举例**

根据上面的描述，可以很容易的发现，如果将比较敏感的数据放在外部存储中，那么其它应用或者恶意用户就可以任意读取其中的敏感信息，这就很容易导致敏感信息的泄漏，这是个比较严重的安全问题。

即使应用保存敏感数据到内部存储中，但是如果将其访问模式设置成了全局可读（`MODE_WORLD_READABLE`），或者全局可写（`MODE_WORLD_READABLE`），那么这也将导致此敏感数据暴露在风险之中。特别说明，虽然`MODE_WORLD_READABLE`和`MODE_WORLD_READABLE`在Android 4.2中已经被禁用了，但是之前版本的系统还是会有影响。

并且就算应用对数据设置了私有模式（`MODE_PRIVATE`），只能在应用内访问此数据。但是如果此应用运行在已越狱的设备上时，那么应用保存在本地的任何明文数据就都可以被root用户访问了。所以，将敏感数据保存在设备本地都是非常不安全的。这将很容易导致敏感数据泄漏的安全问题。

所以，尽量不要把敏感数据保存在设备上。如果确实需要将敏感数据保存在设备本地，那么应该对敏感数据进行加密后再保存。

## 5.2.3 不安全的通信

**概述**

对于任何移动应用其实都离不开要和数据打交道，除了涉及到数据的存储外，还会涉及到数据的传输。这通常又包含移动应用间的通信，以及移动应用客户端到服务器之前的通信。

不安全的通信的一般主要是指数据的完整性、保密性被破坏。主要是敏感数据（如：密钥、密码、用户个人信息、账户信息、会话令牌等）在传输过程中被窃取、篡改，或者没有正确的使用加密连接（如：证书检查、TLS配置等问题），这些都是不安全的通信问题。

**举例**

下面列举两个示例来说明应用中不安全的通信问题。

1. 未加密的敏感信息传输

由于移动应用常常都处于不可信的网络环境中（如：商场、酒店等）。在这样的环境中如果攻击者控制了网络接入点，或者伪造一个网络接入点，那么当用户访问了这样的网络时，攻击者就可以通过像ettercap、tcpdump 这样的工具来嗅探用户的网络数据，甚至可以修改用户发送的数据信息，这就是比较典型的中间人攻击了（MITM)）。

如果用户在这样的环境中使用其移动应用传输了敏感数据（如：账号、密码），而这样的信息又是在未加密的情况下进行传输的话，那么将导致用户的账户信息泄漏，这就是比较常见的不安全的通信问题。

2. 未进行恰当的证书验证

关于不安全的通信问题，另一个比较典型的例子就是没有进行恰当的证书验证。随着开发人员的安全意识的提高，现在大家基本都意识到要使用加密通信方式了（如：TLS）。但是，如果在建立加密连接时没有进行恰当的验证，还是会导致安全问题。

一般在建立安全连接的时候，移动应用程序要检查证书的颁发者是否有效，检查证书是否在有效期内，证书持有者是否和访问的域名一致。如果移动应用没有检查服务器端提供的证书的有效性，且移动应用程序无条件地接受由服务器提供给它的任何证书。这就破坏了在移动应用程序端认证服务端的能力。这种情况的移动应用程序也容易受到中间人攻击，这也就容易出现上面提到的安全问题。

## 5.2.4 不安全的身份认证

**概述**

大多数移动应用都会实现某种用户身份认证。 但是，由于认证方案不佳或缺失可能导致攻击者执行移动应用程序或者其后端服务器的功能。这样的问题可能有：
- 在访问的时候没有对用户进行身份认证；
- 在访问过程中没有保持对用户身份的确认；
- 会话过程中存在漏洞。

通常，认证主要基于以下三种基本方法或因素：
1. "你知道什么"，这些内容示例包括密码、 个人标识码（PIN）或密码短语等。
2. "你拥有什么"，用户拥有能够帮助他们提供身份认证的设备， 示例包括SIM卡、硬件令牌、和智能卡等。
3. "你是什么"，这里指的是某个身体部分或人的生物行为特征。 包括指纹、语音、视网膜、虹膜等。

**举例**

下面是一些比较常见的不安全的认证问题，大家可以通过示例来理解此类安全问题。

1. 暴力猜测账号密码

对于此种暴力攻击不管是在Web系统中还是在移动应用中都是比较普遍的攻击方式。这就是因为应用对账号密码认证没有其它安全控制措施，攻击者几乎可以无限次的进行身份认证的尝试，那么只要攻击者的攻击载荷足够，就能够破解出用户的账号密码信息。特别的，如果没有强密码策略，导致用户都使用一些很简单的密码，那么通过暴力攻击的方式就更加容易猜测到用户的账号密码信息了。

所以对于账号密码登录时候建议还是要有图形验证码或短信验证码的认证，另外，对于账号密码认证错误几次后就应该限制账号的登录行为。

2. 可猜测的会话标识符

通常在认证成功后，应用会使用会话或者令牌的方式作为用户的会话标识符来保持用户的后续访问。但是如果此会话标识符可被猜测，那么这将会是个很严重的安全问题。比如某种会话标识符是递增的，那么攻击者就可以直接猜测到其他用户的会话标识符，这将导致攻击者可以直接操作其他用户的账户；或者某种会话标识符直接使用用户设备的IMEI或其他设备信息来作为会话标识符，由于这样的设备信息比较容易被获取到，并且这样的信息是不变的，被攻击者获取后就可以一直使用，所以这样的设计都是极不安全的。

因此会话标识符应该是唯一的且不可被猜测到的字符串，并且其中不要存放任何敏感信息。


## 5.2.5 加密不足

**概述**

前面我们已经提到了要对敏感数据的存储、传输都应该进行加密处理。然而如果开发人员对加密技术理解不足，或者对加密算法应用不正确，这都将可能导致加密不足的安全问题。

加密的主要目的是提供对数据机密性、完整性和数据真实性的保护。常用的加密相关的概念如下：

- 对称加密，是一种采用单钥密码系统的加密方法，同一个密钥可以同时用作信息的加密和解密。它的加解密速度很快，因此适合于批量数据处理。由于所有访问密钥的人都能够解密加密的内容，因此需要特别小心的对密钥进行管理。
- 非对称加密，有两个密钥，公钥（public key）和私钥（private key）。公钥与私钥是一对，如果用公钥对数据进行加密，只有用对应的私钥才能解密；如果用私钥对数据进行加密，那么只有用对应的公钥才能解密。由于非对称加密比对称加密慢几倍，因此通常仅用于加密少量数据，例如用于批量加密的对称密钥。
- 哈希（HASH），它确定性地将任意长度数据段映射为固定长度值。 通常很容易计算哈希值，但是难以基于哈希值来确定原始值。 加密哈希函数保证对输入数据进行的小的更改会对生成的哈希值产生很大的变化。所以数据的哈希值可以检验数据的完整性。
- 消息认证码（MAC），将其他加密机制（如对称加密、哈希）与密钥相结合，以提供对数据完整性和真实性的保护。

**举例**

下面列出了几个比较常见的加密不足的安全问题：

1. 硬编码加密密钥

对称加密的安全性高度依赖于所使用的密钥的保密性。 如果密钥被公开，则数据通过加密所获得的安全性将会消失。 这就要求密钥被恰当的保护，不要与加密的数据一起存储，也不要直接写在程序代码中。

因为应用的数据和代码都在用户的设备上，而前面在“不安全的数据存储”中我们已提到了在设备上保存敏感信息是非常不安全的行为，敏感数据面临泄漏的风险。另外，在本章后面的“逆向工程”部分我们也会说明设备上的应用也存在被逆向的风险，攻击者可以很容易的获得代码信息，因此密钥写在源代码中也会有很高的泄漏风险。

移动操作系统为密钥提供特别的受保护的存储区域，比如Android的Keystore、iOS的Keychain。 这些存储区域通常可以受到硬件的保护，具有很高的安全性。因此应用程序应该使用这个特殊的存储位置/机制来保存所有密钥。

2. 使用不安全的加密算法

随着技术的发展，许多加密算法已不应该再继续被使用，因为它们已被证明具有明显的缺点，或者对于现代的安全性要求是不够的。 以前认为安全的算法可能会随着时间的推移会变得不再安全。

下面列出了一些不安全的加密算法，建议不要再使用它们了。
- DES
- RC2
- RC4
- MD4
- MD5
- SHA1

另外，即使使用了安全的加密算法，但是如果加密算法的加密模式、位数、填充方式等选择不当，也容易导致加密不足。 比如：

- 不要使用ECB模式，因为它会泄露关于原始数据结构的信息
- 不要使用768-bit的RSA，因为它能被破解
- 不要使用较老的PKCS＃1填充，因为它也会泄漏信息


3. 使用自定义的加密算法

使用非标准或自定义的加密算法是危险的，因为攻击者很可能破解算法并危及受保护的数据。 自定义加密算法是很耗时和困难的，并且很可能失败。因此 应该使用已经证明是安全且知名的加密算法。 所有成熟的框架和库都提供了在实现移动应用时应该使用的加密功能。


## 5.2.6 不安全的授权

**概述**

当用户通过认证后，对于用户能够访问那些功能点就是通过授权来决定的。对于一个普通用户，如果使用存在不安全的授权漏洞的应用，那么就可能导致普通用户越权访问其本不能访问的功能。这可能被攻击者或者恶意应用利用来攻击移动应用。

关于认证和授权之间的区别： 认证是识别用户的行为， 授权是检查所识别的用户具有执行其操作所必需的权限的行为。 

**举例**

对于不安全的授权问题，我们也通过列举几个示例来进行说明。

1. 任意账户信息查询

比如某个银行应用，用户登录认证通过后，就可以查询他自己的账户信息。此处用户选择查询账户信息时，应用将此用户对应的id值发送到服务端，然后服务端返回此id值对应的账户信息。由于应用服务并没有验证此用户是否有查询此id的账户信息的权限，导致用户通过修改id值可以查询其他所有用户的账户信息，这就是一个典型的不安全的授权导致的安全问题。

2. 传输用户角色或权限

有些时候应用也进行了授权处理并会在服务端验证，但是却将角色或权限标识作为URL中的一个字段进行传输，由于会将这样的权限信息发送到客户端，这时如果攻击者修改这样的标识，改为其它角色或权限，那么他就可以进行越权访问了，这也是一个比较典型的不安全授权的问题。



## 5.2.7 代码质量问题

**概述**

代码质量问题主要指代码级的安全问题，比如，C/C++语言的缓冲区溢出，移动应用Webview中的XSS，都是代码质量问题导致的漏洞。对于此类问题，主要是由于使用了不安全的方法/API、使用了不安全的语言结构或其他一些代码中的问题。

由于大多数开发人员对于安全都不甚了解，以及都主要关注于完成业务功能。因此导致开发人员在开发过程中主要精力都在完成功能实现上了，而对于实现功能的代码质量如何，是否存在安全风险并不怎么关注了，这就导致了很多应用的代码都有质量问题，这也就是导致很多安全漏洞的原因。

**举例**

下面也通过几个例子来说明代码质量的安全问题。

1. 缓冲区溢出

安全人员应该都听说过缓冲区溢出，它就是典型的针对程序代码质量问题，向程序输入缓冲区写入使之溢出的内容（通常是超过缓冲区能保存的最大数据量的数据），从而破坏程序运行、并获取程序乃至系统的控制权。

下面是一个存在缓冲区溢出漏洞的示例代码：
``` c
int main(int argc, char **argv) {
	char buf[8];
	gets(buf);
	printf("%s\n", buf);
	return 0;
}
```
在这个例子中，我们应该避免使用gets函数来避免缓冲区溢出。这是大多数静态分析工具作为代码质量问题报告的示例。

2. 异常处理

当应用程序处于非正常或错误状态时，通常会发生异常。当这种状态发生时程序能够抛出异常，这样就能够确保应用程序处于安全状态，而不会在页面或日志中暴露任何敏感信息。但是如果开发的程序代码中没有这样的异常处理机制，那么就可能会导致系统内的敏感信息泄漏或其它未知的安全问题。

3. 注入漏洞

对于注入漏洞，其实在Web时代就是最普遍的一类问题了。它就是对于用户输入的数据没有进行检查和处理，导致用户输入的恶意数据被当作指令执行了，从而对系统造成攻击。下面是一个存在SQL注入漏洞的示例代码：
```Java
String query = "SELECT * FROM accounts WHERE custID='" + request.getParameter("id") + "'";
```
通过这个例子可以发现此类问题就是代码没有对不可信的输入数据采取恰当的安全控制措施导致的。这其实就是开发人员在开发的时候安全意识不足导致的典型的代码质量问题。

## 5.2.8 代码篡改

**概述**

通常，移动应用开发完成后都是通过发布到应用商店供用户下载使用。由于在应用商店中理论上所有人都可以下载应用或发布自己的应用。对于官方商店基本都有比较健全的检查措施，但是对于许多三方商店对应用就基本没有什么检查了。因此这就导致有攻击者在官方商店下载正规的应用后，对应用进行恶意的代码篡改，然后发布到一些三方商店并诱导用户下载，从而达到攻击的目的。

此外，如果终端设备被安装了恶意应用，那么这些恶意应用也可能通过hook，修改内存等方式来达到篡改应用代码的目的。

对于代码篡改，比较典型的包括对应用的核心代码文件的修改、对应用的资源文件的修改、重定向或替换系统API以拦截和执行恶意的外部代码。


**举例**

对于此代码篡改的问题，我们通过列举几个实际场景来说明其问题。

1. 场景1

比如有许多应用内付费的应用，但是往往很多用户是不想付费的，因此攻击者就会使用篡改的正常应用来吸引这些用户。在代码中，攻击者修改代码执行逻辑来绕过应用对于是否付费的检测，从而可以获得只有付费才能获取的功能。当然，攻击者同时也会插入恶意代码来窃取用户信息，或者插入广告代码来发布广告从而获得收益等等。这导致应用程序开发人员失去了合法的收入，而攻击者却获取了非法收入。这样的问题对开发人员来说是非常严重的。

2. 场景2

又比如对于银行类的移动应用，它们都涉及用户的敏感信息处理和现金交易等功能，这些都将吸引攻击者对其代码进行篡改。攻击者会在正常的应用中加入恶意的载荷然后发布出去，如果普通用户使用了这样的恶意应用，那么其个人身份信息和账户信息等都会被此应用发送到攻击者控制的服务器上，这将导致用户的敏感信息泄漏，严重的还可能导致用户卡上的金钱也被转到攻击者的卡上。此类问题非常普遍并且对银行和用户都会造成非常严重的影响。


## 5.2.9 逆向工程

**概述**

逆向工程，是通过如IDA Pro、JEB、Hopper、otool等工具对应用程序进行反编译，然后对应用的配置文件、源代码和库文件等进行分析，然后推导出此应用的结构、算法、处理过程、运行方法等信息。这可用于在应用程序中发现安全漏洞，并可揭露有关后端服务器、加密算法、密码以及知识产权等信息。

由于代码的固有特性导致移动应用程序都容易受到逆向工程的影响。又因为当前写应用程序的大多数语言都丰富了元数据，极大地帮助了程序员调试应用程序。但是同样的功能也可以帮助攻击者了解应用程序的工作原理，所以这就导致逆向是目前所有移动应用都普遍面临的一个安全问题。


**举例**

对于逆向工程的安全问题，我们通过列举几个实践场景来说明其问题。

1. 字符串表分析

攻击者可以直接将移动应用程序包放在反编译工具（如：IDA Pro）里面，对应用进行反编译处理。然后可以选择查看字符串。攻击者就可以通过这样的方式发现一些敏感的字符串信息，比如硬编码的密码，访问后端系统的认证凭证，甚至有连接数据库的账户密码等敏感信息。攻击者就可以通过获得的这些敏感信息进行更加深入的攻击。


2. 源代码分析

不管是Android的APK文件还是iOS的IPA文件，它们其实都是个压缩文件，可以直接使用 7zip/Winrar/WinZip/Gunzip这些软件对其进行解压缩处理。比如APK文件，解压后攻击者可以获得manifest文件、assets、resources 和最重要的classes.dex文件。然后攻击者就可以通过manifest文件来分析应用的程序架构，通过将dex转换为jar，然后使用JD-GUI查看源代码，攻击者就可以分析代码逻辑，然后就可以像上面“代码篡改”部分提到的那样篡改应用程序，或者通过对代码的分析发现其中的漏洞，然后以此来攻击应用系统。


## 5.2.10 无关的功能

**概述**

在应用程序开发过程中，开发人员往往为了开发和测试方便，常常使用一些对业务来说无关的功能。比如将一些应用运行过程中的敏感信息输出到日志中以方便跟踪程序运行情况；使用一个隐藏的登录接口来绕过认证直接访问应用系统进行测试；或者将密码或其它敏感信息写在注释里面以方便测试。这些功能虽然能够方便程序员开发和测试程序，也方便了测试人员进行测试；但是，如果在正式发布发布应用程序的时候没有将这些无关的功能从程序中移除，那么就可能会被攻击者利用从而造成严重的安全问题。

简单来说，无关的功能问题就是在应用程序中启用了在发布时并不打算发布的功能。通过这些额外的能力，应用就有窃取敏感数据或访问未经授权功能的高风险。

**举例** 

对于无关的功能这类安全问题，我们还是通过示例来进行说明。

1. 日志中泄漏敏感信息

有时候开发人员为了开发方便，会输出日志信息以方便其测试，但是如果其中输出有敏感信息（如用户的登录凭证、身份信息等），而在程序正式发布后还有这样的无关功能。那么攻击者就可以通过上面提到的“逆向工程”的方法对应用程序进行分析，可以通过`logcat`来查看应用输出的日志记录，如果其中有这些敏感信息，那么这会导致攻击者可以获得正常用户的登录凭证或者用户信息，这将是很严重的安全问题。

2. 隐藏接口暴露

另一个比较常见的场景就是开发人员为了方便会在程序中留一些隐藏的接口方便自己访问，这样做可以绕过复杂的业务逻辑，方便开发或测试人员直接访问到其想要访问的业务。但是如果这样的无关功能还存在于已发布的应用中的话，就非常容易被攻击者通过“逆向工程”的方法发现，这就给攻击者提供了可以绕过安全控制措施的路径，直接访问到应用的业务功能。这显然对应用来说是个严重的安全问题。

所以，在正式发布的应用中移除无关的功能是非常重要的。
